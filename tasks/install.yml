---
- name: Update pacman repositories cache
  pacman:
    update_cache: yes
  changed_when: false
  when: ansible_pkg_mgr == "pacman"

- name: Install pacman packages
  pacman:
    name: "{{ item }}"
  with_items:
    - postgresql
    - postgresql-docs
    - postgresql-old-upgrade
    - python2-psycopg2
  when: ansible_pkg_mgr == "pacman"

- name: Update apt repositories cache
  apt:
    update_cache: yes
  changed_when: false
  when: ansible_pkg_mgr == "apt"

- name: Install apt packages
  apt:
    name: "{{ item }}"
  with_items:
    - postgresql
    - postgresql-client
    - postgresql-doc
    - python-psycopg2
  register: apt
  when: ansible_pkg_mgr == "apt"

- name: Stop PostgreSQL
  service:
    name: postgresql.service
    state: stopped
  when: ansible_pkg_mgr == "apt" and apt.changed

- name: Ensure Postgres group exists
  group:
    name: "{{ postgres_group }}"
    gid: 88
    system: true

- name: Ensure Postgres user exists
  user:
    name: "{{ postgres_user }}"
    group: "{{postgres_group }}"
    uid: 88
    shell: /bin/false
    home: "{{ postgres_home_directory }}"
    comment: "PostgreSQL user"
    createhome: false

- name: Create configuration directory
  file:
    path: "{{ postgres_conf_directory }}"
    state: directory
    mode: 0750
    owner: root
    group: postgres

- name: Create directoreies
  file:
    path: "{{ item }}"
    state: directory
    mode: 0700
    owner: "{{ postgres_user }}"
    group: "{{ postgres_group }}"
  with_items:
    - "{{ postgres_data_directory }}"
    - "{{ postgres_log_directory }}"
    - "{{ postgres_home_directory }}"
